version: 2.1

jobs:
  build:
    docker:
      - image: circleci/python:3.8
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install flask scikit-learn joblib
      - setup_remote_docker:
          version: default
      - run:
          name: Build Docker image
          command: docker build -t mlapp:latest .

      - run:
        name: Install AWS CLI
        command: |
          sudo apt-get update
          sudo apt-get install -y awscli

      - run:
          name: Upload code to S3
          command: |
            aws s3 cp . s3://codebucket-ml-app/ --recursive
          
  deploy_to_ec2:
    docker:
      - image: circleci/python:3.8  # Image with Python for AWS CLI
    steps:
      - checkout

      # Step 1: Create SSH directory and save SSH key from environment variable
      - run:
          name: Save SSH key
          command: |
            mkdir -p ~/.ssh
            echo "$AWS_SSH_KEY" > ~/.ssh/aws_key.pem
            chmod 400 ~/.ssh/aws_key.pem  # Set the correct permissions for the SSH key

      # Step 2: Add the EC2 instance to known hosts using the EC2_PUBLIC_IP environment variable
      - run:
          name: Add EC2 to known hosts
          command: ssh-keyscan -H $EC2_PUBLIC_IP >> ~/.ssh/known_hosts

      # Step 3: SSH into EC2 and deploy the app using the EC2_PUBLIC_IP environment variable
      - run:
          name: SSH to EC2 and Deploy App
          command: |
            ssh -T -o StrictHostKeyChecking=no -i ~/.ssh/aws_key.pem ubuntu@$EC2_PUBLIC_IP \<<EOF
              docker pull mlapp:latest
              docker stop mlapp || true
              docker rm mlapp || true
              docker run -d -p 80:5000 --name mlapp mlapp:latest
            EOF

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy_to_ec2:
          requires:
            - build

            
